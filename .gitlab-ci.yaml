stages:
  - validate
  - cost

variables:
  TF_ROOT: "."
  INFRACOST_API_KEY: $INFRACOST_API_KEY

before_script:
  - apt-get update && apt-get install -y curl unzip git
  - curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list
  - apt update && apt install terraform -y
  - curl -s https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
  - export PATH="$HOME/.infracost/bin:$PATH"
  - terraform -chdir=$TF_ROOT init

validate:
  stage: validate
  script:
    - terraform -chdir=$TF_ROOT validate

cost-estimate:
  stage: cost
  script:
    - infracost breakdown --path=$TF_ROOT --format=json --out-file=/tmp/infracost.json
    - infracost diff --path=$TF_ROOT --format=gitlab-comment --compare-to=/tmp/infracost.json > /tmp/comment.md || true
    - cat /tmp/comment.md
  artifacts:
    paths:
      - /tmp/infracost.json
      - /tmp/comment.md
